var W=Object.defineProperty,H=Object.defineProperties;var z=Object.getOwnPropertyDescriptors;var V=Object.getOwnPropertySymbols;var Z=Object.prototype.hasOwnProperty,K=Object.prototype.propertyIsEnumerable;var N=(p,c,g)=>c in p?W(p,c,{enumerable:!0,configurable:!0,writable:!0,value:g}):p[c]=g,C=(p,c)=>{for(var g in c||(c={}))Z.call(c,g)&&N(p,g,c[g]);if(V)for(var g of V(c))K.call(c,g)&&N(p,g,c[g]);return p},X=(p,c)=>H(p,z(c));var NetlessAppGeoGebra=function(p){"use strict";const c="!#%()*+,-./:;=?@[]^_`{|}~ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",g=c.length,k=Array(20),v=()=>{for(let n=0;n<20;n++)k[n]=c.charAt(Math.random()*g);return k.join("")};class x{constructor(){this.disposers=new Map}add(r,e=v()){return this.flush(e),this.disposers.set(e,r()),e}addDisposer(r,e=v()){return this.flush(e),this.disposers.set(e,r),e}addEventListener(r,e,s,t,i=v()){return this.add(()=>(r.addEventListener(e,s,t),()=>r.removeEventListener(e,s,t)),i),i}setTimeout(r,e,s=v()){return this.add(()=>{const t=window.setTimeout(()=>{this.remove(s),r()},e);return()=>window.clearTimeout(t)},s)}setInterval(r,e,s=v()){return this.add(()=>{const t=window.setInterval(r,e);return()=>window.clearInterval(t)},s)}remove(r){const e=this.disposers.get(r);return this.disposers.delete(r),e}flush(r){const e=this.remove(r);if(e)try{e()}catch(s){console.error(s)}}flushAll(){this.disposers.forEach(r=>{try{r()}catch(e){console.error(e)}}),this.disposers.clear()}}function B(n){return n!=null&&typeof n=="object"&&!Array.isArray(n)}function R(n,r){let e=n.getAttributes();if(e||(n.setAttributes(r),e=n.getAttributes()),!e)throw new Error("[NetlessAppMonaco] No attributes");return B(r)&&Object.keys(r).forEach(s=>{Object.prototype.hasOwnProperty.call(e,s)||n.updateAttributes([s],r[s])}),e}let L;function D(n){if(window.GGBApplet)return Promise.resolve(window.GGBApplet);if(L)return L;{const r=document.createElement("script");if(L=new Promise((e,s)=>{r.onload=()=>e(window.GGBApplet),r.onerror=()=>{L=void 0,s()}}),n){const e=n.lastIndexOf("GeoGebra")+8;r.src=n.slice(0,e)+"/deployggb.js"}else r.src="https://www.geogebra.org/apps/deployggb.js";return document.head.appendChild(r),L}}const _={appName:"classic",showMenuBar:!0,showAlgebraInput:!0,showToolBar:!0,customToolBar:"0 39 73 62 | 1 501 67 , 5 19 , 72 75 76 | 2 15 45 , 18 65 , 7 37 | 4 3 8 9 , 13 44 , 58 , 47 | 16 51 64 , 70 | 10 34 53 11 , 24  20 22 , 21 23 | 55 56 57 , 12 | 36 46 , 38 49  50 , 71  14  68 | 30 29 54 32 31 33 | 25 17 26 60 52 61 | 40 41 42 , 27 28 35 , 6",showToolBarHelp:!1,showResetIcon:!1,enableFileFeatures:!1,enableLabelDrags:!1,enableShiftDragZoom:!0,enableRightClick:!0,errorDialogsActive:!1,allowStyleBar:!1,preventFocus:!1,useBrowserForJS:!0,language:"en",borderColor:"transparent"},S=class{constructor(n){var r;this.currentAnimations=[],this.embeds={},this.storageCallback=0,this.initAllEmbeds=()=>{for(const e of this.api.getAllObjectNames("embed"))this.initEmbed(e)},this.objectsInWaiting=[],this.updateCallback=0,this.dispatchUpdates=()=>{this.updateCallback||(this.updateCallback=setTimeout(this._dispatchUpdates,this.delay))},this._dispatchUpdates=()=>{const{objectsInWaiting:e}=this;this.objectsInWaiting=[];for(const s of e){const t=this.api.getEmbeddedCalculators(!0),i=t==null?void 0:t[s];(i==null?void 0:i.controller)&&this.sendEvent("evalGMContent",i.toJSON(),s);const o=this.api.getCommandString(s,!1);if(o){this.sendEvent("evalCommand",`${s} := ${o}`,s);const a=this.api.getObjectsOfItsGroup(s);(a==null?void 0:a.length)&&this.sendEvent("addToGroup",s,a)}if(!o||this.api.isMoveable(s)){const a=this.api.getXML(s);this.sendEvent("evalXML",a,s)}this.sendEvent("select",s,!0)}this.updateCallback=0},this.updateListener=e=>{(this.api.hasUnlabeledPredecessors(e)||this.api.isMoveable(e))&&!this.currentAnimations.includes(e)&&(this.objectsInWaiting.includes(e)||(this.objectsInWaiting.push(e),this.dispatchUpdates()))},this.addListener=e=>{const s=this.api.getImageFileName(e);if(s){const a=this.api.getFileJSON();for(const u of a.archive)u.fileName.includes(s)&&this.sendEvent("addImage",JSON.stringify(u))}const t=this.api.getXML(e),o=this.api.getCommandString(e)&&this.api.getAlgorithmXML(e);this.sendEvent("addObject",o||t,e),this.sendEvent("deselect"),this.sendEvent("select",e,!0),setTimeout(()=>this.initEmbed(e),500)},this.removeListener=e=>{this.sendEvent("deleteObject",e),delete this.embeds[e]},this.renameListener=(e,s)=>{this.sendEvent("renameObject",e,s)},this.isSyncingViewState=0,this.stopSyncViewState=()=>{this.isSyncingViewState=0},this._flushViewState=()=>{const{invXscale:e,invYscale:s,xMin:t,yMin:i}=JSON.parse(this.api.getViewProperties(0)),o=1/e,a=-t/e,u=-i/s;return this.viewState={scale:o,x:a,y:u},this.viewSyncCallback=0,this.viewState},this.clientListener=e=>{let s,t;const i=e.type;switch(i){case"updateStyle":s=e.target,t=this.api.getXML(s),this.sendEvent("evalXML",t);break;case"editorStart":this.lastEditingLabel=e.target;break;case"editorKeyTyped":t=this.api.getEditorState(),this.sendEvent("setEditorState",t,this.lastEditingLabel);break;case"editorStop":this.lastEditingLabel=void 0,this.sendEvent("setEditorState",JSON.stringify({content:""}));break;case"deselect":this.sendEvent("deselect",e.target);break;case"select":this.sendEvent("select",e.target);break;case"embeddedContentChanged":s=e[1],t=e[2],this.sendEvent("embeddedContentChanged",t,s);break;case"undo":case"redo":case"addPolygonComplete":t=this.api.getXML(),this.sendEvent("setXML",t);break;case"addSlide":this.sendEvent(i);break;case"removeSlide":case"moveSlide":case"selectSlide":case"clearSlide":case"orderingChange":t=e[2],this.sendEvent(i,t);break;case"pasteSlide":({cardIdx:t,ggbFile:s}=e),this.sendEvent(i,t,s);break;case"startAnimation":s=e[1],this.currentAnimations.push(s),this.sendEvent(i,s,s);break;case"stopAnimation":s=e[1],this.currentAnimations.splice(this.currentAnimations.indexOf(s),1),this.sendEvent(i,s,s);break;case"groupObjects":case"ungroupObjects":t=e.targets,this.sendEvent(i,t);break;case"pasteElmsComplete":t=e.targets.map(o=>this.api.getXML(o)).join(""),this.sendEvent("evalXML",t);break;case"addGeoToTV":case"removeGeoFromTV":t=e[1],this.sendEvent(i,t);break;case"setValuesOfTV":t=e[2],this.sendEvent(i,t);break;case"showPointsTV":({column:t,show:s}=e),this.sendEvent(i,t,s);break;case"lockTextElement":case"unlockTextElement":t=e[1],this.sendEvent(i,t);break;case"viewChanged2D":this.viewSyncCallback||(this.isSyncingViewState||this.viewState.scale===0?this.viewSyncCallback=setTimeout(this._flushViewState,this.delay):this.viewSyncCallback=setTimeout(this._sendViewSyncEvent,this.delay));break;case"mouseDown":case"deleteGeos":case"dragEnd":break;default:console.debug("[GeoGebra] unhandled event ",e.type,e)}},this.viewSyncCallback=0,this.viewState={scale:0,x:0,y:0},this._sendViewSyncEvent=()=>{this._flushViewState(),this.sendEvent("viewChanged2D",JSON.stringify(this.viewState)),this.viewSyncCallback=0},this._delayedRegisterListeners=()=>{this.registerListeners(),this.viewSyncCallback=0},this.conflictedObjects=[],this.dispatch=e=>{var u,m;if(this.conflictedObjects.includes(e.label)&&e.type!=="conflictResolution")return;const t=e.embedLabel?this.embeds[e.embedLabel]:this,i=e.type,o=e.label,a=e.content;if(console.debug("[GeoGebra] receive:",i,o,a),i==="addObject")if(t.api.exists(o))if(this.context.isDecider)if(this.context.isDecider(this.clientId)){let l=1,h;do h=`${o}_${l}`,l++;while(t.api.exists(h));this.unregisterListeners(),t.api.renameObject(o,h),this.registerListeners();const d=t.api.getAlgorithmXML(h)||t.api.getXML(h);this.sendEvent("conflictResolution",d,o)}else this.conflictedObjects.push(o);else t.evalXML(a),t.api.previewRefresh();else t.evalXML(a),t.api.previewRefresh();else if(i==="conflictResolution"){const l=this.conflictedObjects.indexOf(o);l!==-1&&this.conflictedObjects.splice(l,1),t.evalXML(a),t.api.previewRefresh()}else if(i==="evalXML")t.evalXML(a),t.api.previewRefresh();else if(i==="setXML")t.setXML(a);else if(i==="evalCommand")t.evalCommand(a),t.api.previewRefresh();else if(i==="deleteObject")t.unregisterListeners(),t===this&&delete this.embeds[a],t.api.deleteObject(a),t.registerListeners();else if(i==="setEditorState")t.unregisterListeners(),t.api.setEditorState(a,o),t.registerListeners();else if(i==="addImage"){const l=JSON.parse(a);t.api.addImage(l.fileName,l.fileContent)}else if(["addSlide","removeSlide","moveSlide","clearSlide"].includes(i))t.api.handleSlideAction(i,a);else if(i==="selectSlide")t.unregisterListeners(),t.api.selectSlide(a),t.registerListeners();else if(i==="renameObject")t.unregisterListeners(),t.api.renameObject(a,o),t.registerListeners();else if(i==="pasteSlide")t.api.handleSlideAction(i,a,o);else if(i==="evalGMContent"){const l=(t.api.getEmbeddedCalculators(!0)||{})[o];l&&l.loadFromJSON(a)}else if(i==="startAnimation")t.api.setAnimating(o,!0),t.api.startAnimation();else if(i==="stopAnimation")t.api.setAnimating(o,!1);else if(i==="select"){if(a){const l=((m=(u=this.context).getColor)==null?void 0:m.call(u,e.clientId))||"#80808080";t.api.addMultiuserSelection(String(e.nickName),l,a,!!o)}}else if(i==="deselect")t.api.removeMultiuserSelections(String(e.nickName));else if(i==="orderingChange")t.api.updateOrdering(a);else if(i==="groupObjects")t.api.groupObjects(a);else if(i==="ungroupObjects")t.api.ungroupObjects(a);else if(i==="addToGroup")t.api.addToGroup(a,o);else if(i==="embeddedContentChanged")t.api.setEmbedContent(o,a);else if(i==="addGeoToTV")t.api.addGeoToTV(a);else if(i==="setValuesOfTV")t.api.setValuesOfTV(a);else if(i==="removeGeoFromTV")t.api.removeGeoFromTV(a);else if(i==="showPointsTV")t.api.showPointsTV(a,o);else if(i==="lockTextElement")t.api.lockTextElement(a);else if(i==="unlockTextElement")t.api.unlockTextElement(a);else if(i==="viewChanged2D")if(t.viewState.scale===0)t.api.evalCommand("Pan(0,0)"),t.startSyncViewState();else{const{scale:l,x:h,y:d}=JSON.parse(a),b=t._flushViewState();t.startSyncViewState(),t.api.evalCommand(`Pan(${h-b.x},${d-b.y})`),t.api.evalCommand(`ZoomIn(${l/b.scale})`)}else console.debug("[GeoGebra] unknown event",i,a,o)},this.api=n.api,this.clientId=n.clientId,this.nickName=n.nickName,this.delay=(r=n.delay)!=null?r:200,this.context=n,setTimeout(()=>{this.api.evalCommand("Pan(0,0)")},this.delay)}createEvent(n,r,e){const s={type:n,content:r,clientId:this.clientId,nickName:this.nickName};return this.context.embedLabel&&(s.embedLabel=this.context.embedLabel),e&&(s.label=e),s}sendEvent(n,r,e){console.log("[GeoGebra] send:",n,e,r),this.context.postMessage(this.createEvent(n,r,e)),this.storageCallback||(this.storageCallback=setTimeout(()=>{this.context.save(this.api.getBase64()),this.storageCallback=0},this.delay))}evalCommand(n){this.unregisterListeners(),this.api.evalCommand(n),this.registerListeners()}evalXML(n){this.unregisterListeners(),this.api.evalXML(n),this.api.updateConstruction(),this.registerListeners(),setTimeout(this.initAllEmbeds,500)}setXML(n){this.unregisterListeners(),this.api.setXML(n),this.api.updateConstruction(),this.registerListeners()}initEmbed(n){if(this.embeds[n])return;const r=this.api.getEmbeddedCalculators();if(!r)return;const e=r[n];if(e&&"registerClientListener"in e){const s=new S(X(C({},this.context),{clientId:this.clientId,nickName:this.nickName,api:e,embedLabel:n}));s.registerListeners(),this.embeds[n]=s}}startSyncViewState(){clearTimeout(this.isSyncingViewState),this.isSyncingViewState=setTimeout(this.stopSyncViewState,1e3)}shouldSyncView(n,r,e,s){return Math.abs(r-n.scale)>S.Threshold/10||Math.abs(e-n.x)>S.Threshold||Math.abs(s-n.y)>S.Threshold}registerListeners(){this.api.registerUpdateListener(this.updateListener),this.api.registerRemoveListener(this.removeListener),this.api.registerAddListener(this.addListener),this.api.registerClientListener(this.clientListener),this.api.registerRenameListener(this.renameListener)}unregisterListeners(){this.api.unregisterUpdateListener(this.updateListener),this.api.unregisterRemoveListener(this.removeListener),this.api.unregisterAddListener(this.addListener),this.api.unregisterClientListener(this.clientListener),this.api.unregisterRenameListener(this.renameListener)}};let M=S;M.Threshold=20;var P=`.netless-app-geogebra{width:100%!important;height:100%!important;overflow:hidden}.netless-app-geogebra.loading{background-color:#fff}.netless-app-geogebra.readonly{user-select:none;pointer-events:none}
`;function F(n,r){const e=new ResizeObserver(()=>r(n));return e.observe(n),()=>e.disconnect()}function J(n,r,e){const s=n.getDisplayer(),t=n.getRoom();let i=[];const o=l=>{l.authorId!==s.observerId&&i.forEach(h=>h(l.payload))},a="sync--"+n.appId;return s.addMagixEventListener(a,o),{service:{addListener(l){i.push(l)},postMessage(l){t==null||t.dispatchMagixEvent(a,l)},load(){return r[e]},save(l){n.updateAttributes([e],l)}},disposer:()=>{i=[],s.removeMagixEventListener(a)}}}const U={kind:"GeoGebra",async setup(n){var A,G;const r=n.getDisplayer(),e=r.observerId,s=(A=r.state.roomMembers.find(f=>f.memberId===e))==null?void 0:A.payload,t=(s==null?void 0:s.uid)||"",i=(s==null?void 0:s.nickName)||t,o=(G=n.getAppOptions())==null?void 0:G.HTML5Codebase,a=R(n,{uid:"",ggbBase64:""}),u=n.getBox();u.mountStyles(P);const m=document.createElement("div");m.classList.add("netless-app-geogebra","loading"),t!==a.uid&&a.uid&&m.classList.add("netless-app-geogebra","readonly"),u.mountContent(m);const l=new x,h=C({},_);a.ggbBase64&&(h.ggbBase64=a.ggbBase64),h.id="ggb_"+n.appId;let d;const b=J(n,a,"ggbBase64");function O(){const{width:f,height:w}=m.getBoundingClientRect();d==null||d.setWidth(f),d==null||d.setHeight(w)}h.appletOnLoad=f=>{console.log(`[GeoGebra]: loaded ${JSON.stringify(h.id)}`),d=f,O(),m.classList.remove("loading");const w=n.getDisplayer(),j=new M(C({clientId:w.observerId,nickName:i,api:f,isDecider:y=>w.state.roomMembers.map(E=>E.memberId).every(E=>y<=E),getColor:y=>{const I=w.memberState(y).strokeColor;return"#"+I.map(E=>E.toString(16).padStart(2,"0")).join("")+"80"}},b.service));j.registerListeners(),b.service.addListener(y=>{j.dispatch(y),d==null||d.setUndoPoint()})},l.add(()=>F(m,O)),n.emitter.on("destroy",()=>{console.log("[GeoGebra]: destroy"),l.flushAll(),b.disposer(),d==null||d.remove()});const $=await D(o),T=new $(h);o&&T.setHTML5Codebase(o),T.inject(m)}};return p.default=U,Object.defineProperty(p,"__esModule",{value:!0}),p[Symbol.toStringTag]="Module",p}({});
//# sourceMappingURL=main.iife.js.map